<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Retirement Planner Pro</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container-fluid py-4 app-container" style="max-width: 1700px;">
    
    <div class="main-header d-flex flex-wrap justify-content-between align-items-center shadow-sm gap-3 mb-4 rounded-4">
      <div class="d-flex align-items-center flex-wrap gap-3">
        <h4 class="mb-0 text-nowrap fw-bold d-flex align-items-center">
          <i class="bi bi-graph-up-arrow text-primary me-3 fs-3"></i>Retirement Planner
        </h4>
        <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-50 d-none fs-6 fw-normal px-3 py-2 rounded-pill" id="currentScenarioBadge">
          Plan: <span id="currentScenarioName" class="fw-bold"></span>
        </span>
      </div>
      
      <div class="d-flex align-items-center flex-wrap gap-2 gap-md-3">

        <div class="btn-group shadow-sm">
            <button class="btn btn-primary d-flex align-items-center gap-2 px-3" data-bs-toggle="modal" data-bs-target="#saveScenarioModal" title="Save Plan">
                <i class="bi bi-floppy"></i> <span class="d-none d-sm-inline">Save</span>
            </button>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary d-flex align-items-center gap-2 px-3 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Load Plan">
                    <i class="bi bi-folder2-open"></i> <span class="d-none d-sm-inline">Load</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg" id="headerScenarioList">
                    <li><span class="dropdown-item-text text-muted small">No saved plans</span></li>
                </ul>
            </div>
        </div>

        <button class="btn btn-outline-danger shadow-sm d-flex align-items-center gap-2 px-3" id="btnClearAll" type="button" title="Clear All Data">
            <i class="bi bi-trash3"></i> <span class="d-none d-sm-inline">Clear All</span>
        </button>

        <button class="btn btn-outline-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" id="btnThemeToggle" title="Toggle Light/Dark Mode">
          <i class="bi bi-sun-fill"></i>
        </button>
        
        <div class="d-none d-xl-block text-end border-start border-secondary ps-3 ms-1">
          <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch mb-0">
              <input class="form-check-input" type="checkbox" id="useRealDollars">
              <label class="form-check-label small text-nowrap fw-medium" for="useRealDollars">Today's $</label>
            </div>
            <div class="d-flex align-items-center text-success" title="Auto-save is active. Your changes are saved locally." style="cursor: help;">
              <i class="bi bi-cloud-check-fill fs-5"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs border-0 flex-nowrap overflow-auto hide-scrollbar m-0" id="myTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-pane" type="button" role="tab"><i class="bi bi-pencil-square me-2"></i>Inputs</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab"><i class="bi bi-table me-2"></i>Projection</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-pane" type="button" role="tab"><i class="bi bi-sliders me-2"></i>Strategy</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="risk-tab" data-bs-toggle="tab" data-bs-target="#risk-pane" type="button" role="tab"><i class="bi bi-activity me-2"></i>Risk (Monte Carlo)</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="cashflow-tab" data-bs-toggle="tab" data-bs-target="#cashflow-pane" type="button" role="tab"><i class="bi bi-diagram-3 me-2"></i>Cash Flow</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="sim-tab" data-bs-toggle="tab" data-bs-target="#sim-pane" type="button" role="tab"><i class="bi bi-magic me-2"></i>Simulations</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="scenarios-tab" data-bs-toggle="tab" data-bs-target="#scenarios-pane" type="button" role="tab"><i class="bi bi-save me-2"></i>Files</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="compare-tab" data-bs-toggle="tab" data-bs-target="#compare-pane" type="button" role="tab"><i class="bi bi-bar-chart-line me-2"></i>Compare</button></li>
            </ul>
        </div>
    </div>

    <div class="row g-4">
      <div class="col-12" id="mainCol">
        <div class="card shadow-sm mb-5 border-secondary h-100">
          <div class="card-body p-0">
            <div class="tab-content" id="myTabContent">

              <div class="tab-pane fade show active p-3 p-md-4" id="plan-pane" role="tabpanel">
                <form id="financialForm">
                  
                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-between surface-card border-bottom border-secondary p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-vcard text-primary fs-4 me-3"></i>
                            <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">1. Personal Information</h5>
                            <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Personal Details" data-bs-content="Set your Date of Birth and targeted Retirement Age. <b>Life Expectancy</b> defines how long the simulation runs (ensuring you don't run out of money too early).">
                              <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                        
                        <div class="btn-group bg-input rounded-3 shadow-sm p-1 border border-secondary" role="group">
                          <input type="radio" class="btn-check" name="planMode" id="modeSingle" autocomplete="off">
                          <label class="btn btn-sm btn-toggle px-3 rounded-2" for="modeSingle"><i class="bi bi-person me-1"></i> Single</label>
                          <input type="radio" class="btn-check" name="planMode" id="modeCouple" autocomplete="off" checked>
                          <label class="btn btn-sm btn-toggle px-3 rounded-2" for="modeCouple"><i class="bi bi-people me-1"></i> Couple</label>
                        </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="row g-4">
                        <div class="col-12 col-xl-6">
                          <div class="p-4 border border-secondary rounded-3 surface-card h-100 position-relative overflow-hidden">
                            <div class="position-absolute top-0 start-0 w-100 border-top border-info border-3"></div>
                            <h6 class="text-info fw-bold mb-4 text-uppercase ls-1"><i class="bi bi-person-fill me-2"></i>Player 1 (P1)</h6>
                            <div class="mb-4">
                              <label class="form-label">Date of Birth</label>
                              <div class="d-flex align-items-center gap-3">
                                <input type="month" class="form-control live-calc" id="p1_dob" value="1988-09" required style="max-width: 200px;">
                                <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2 rounded-pill fs-6" id="p1_age">-- years old</span>
                              </div>
                            </div>
                            <div class="row g-4">
                              <div class="col-6"><label class="form-label">Retirement Age</label><input type="text" class="form-control live-calc formatted-num" id="p1_retireAge" value="60"></div>
                              <div class="col-6"><label class="form-label">Life Expectancy</label><input type="text" class="form-control live-calc formatted-num" id="p1_lifeExp" value="90"></div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-xl-6 p2-column">
                          <div class="p-4 border border-secondary rounded-3 surface-card h-100 position-relative overflow-hidden">
                            <div class="position-absolute top-0 start-0 w-100 border-top border-purple border-3" style="border-color: var(--purple) !important;"></div>
                            <h6 class="text-purple fw-bold mb-4 text-uppercase ls-1"><i class="bi bi-person-fill me-2"></i>Player 2 (P2)</h6>
                            <div class="mb-4">
                              <label class="form-label">Date of Birth</label>
                              <div class="d-flex align-items-center gap-3">
                                <input type="month" class="form-control live-calc" id="p2_dob" value="1992-07" style="max-width: 200px;">
                                <span class="badge bg-purple bg-opacity-10 text-purple border border-purple px-3 py-2 rounded-pill fs-6" style="color: var(--purple) !important; border-color: var(--purple) !important; background-color: rgba(139, 92, 246, 0.1) !important;" id="p2_age">-- years old</span>
                              </div>
                            </div>
                            <div class="row g-4">
                              <div class="col-6"><label class="form-label">Retirement Age</label><input type="text" class="form-control live-calc formatted-num" id="p2_retireAge" value="60"></div>
                              <div class="col-6"><label class="form-label">Life Expectancy</label><input type="text" class="form-control live-calc formatted-num" id="p2_lifeExp" value="95"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-between surface-card border-bottom border-secondary p-3">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-wallet2 text-success fs-4 me-3"></i>
                        <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">2. Portfolio Assets</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Assets & Returns" data-bs-content="Enter your <b>current</b> balances. The <b>Return %</b> is your expected annual growth. <br><br>Toggle <b>Advanced Mode</b> to set different return rates for after you retire.<br><br><b>Note:</b> Account details are collapsed by default to save space. Click the arrow to expand.">
                          <i class="bi bi-info-circle"></i>
                        </button>
                      </div>
                      <div class="form-check form-switch mb-0">
                        <input class="form-check-input live-calc mt-1" type="checkbox" id="asset_mode_advanced" role="switch">
                        <label class="form-check-label small fw-bold text-uppercase ls-1 text-muted ms-1" for="asset_mode_advanced">Adv. Mode</label>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div class="row g-4">
                        <div class="col-12 col-xl-6">
                          <div class="card border-secondary surface-card shadow-none">
                            <div class="card-body p-3 p-md-4">
                              <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom border-secondary">
                                <h6 class="text-info mb-0 fw-bold text-uppercase ls-1">P1 Asset Mix</h6>
                                <button class="btn btn-sm btn-outline-info rounded-circle p-1 d-flex align-items-center justify-content-center" style="width:28px; height:28px;" type="button" data-bs-toggle="collapse" data-bs-target="#p1_assets_collapse" aria-expanded="false" title="Expand/Collapse">
                                  <i class="bi bi-chevron-down"></i>
                                </button>
                              </div>
                              
                              <div class="collapse" id="p1_assets_collapse">
                                <div class="row g-2 align-items-end mb-3"><div class="col-3"><label class="form-label text-muted mb-0">Account</label></div><div class="col-5 asset-bal-col"><label class="form-label text-muted mb-0">Balance ($)</label></div><div class="col-4 asset-ret-col"><label class="form-label text-muted mb-0 lbl-ret">Return (%)</label></div><div class="col-3 adv-asset-col" style="display:none;"><label class="form-label text-warning mb-0" title="Post-Retirement Return">Ret. Ret(%)</label></div></div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Cash <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Interest income is 100% taxable at your marginal rate. No tax sheltering."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_cash" value="20,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_cash_ret" value="2.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_cash_ret_retire" value="2.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        TFSA <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Tax-Free Savings Account. Growth and withdrawals are 100% tax-free."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_tfsa" value="52,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_tfsa_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_tfsa_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        RRSP <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Registered Retirement Savings Plan. Tax-deductible contributions. Tax-deferred growth. 100% taxable withdrawals."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_rrsp" value="85,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_rrsp_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_rrsp_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        LIRF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Locked-in Retirement Account (LIRA). Pension funds locked until retirement. Tax-deferred."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_lirf" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_lirf_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_lirf_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        LIF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Life Income Fund. Payout vehicle for LIRA. Has min/max annual limits. 100% taxable."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_lif" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_lif_ret" value="5.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_lif_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        RRIF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Registered Retirement Income Fund. Payout vehicle for RRSP. Mandatory minimum withdrawals. 100% taxable."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_rrif_acct" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_rrif_acct_ret" value="5.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_rrif_acct_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Non-Reg <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Taxable Investment Account. Yields (dividends/interest) taxed annually. Capital gains taxed at 50% inclusion on sale."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_nonreg" value="10,000"></div>
                                    <div class="col-4 asset-ret-col">
                                        <div class="d-flex flex-column gap-1">
                                            <div class="input-group input-group-sm" title="Total Return"><span class="input-group-text border-secondary text-muted px-1" style="font-size:0.7rem;">Tot</span><input type="number" step="0.01" class="form-control live-calc px-1" id="p1_nonreg_ret" value="5.0"><span class="input-group-text px-1">%</span></div>
                                            <div class="input-group input-group-sm" title="Yield (Dividends/Interest)"><span class="input-group-text border-secondary text-muted px-1" style="font-size:0.7rem;">Yld</span><input type="number" step="0.01" class="form-control live-calc px-1" id="p2_nonreg_yield" value="2.0"><span class="input-group-text px-1">%</span></div>
                                        </div>
                                    </div>
                                    <div class="col-3 adv-asset-col" style="display:none;">
                                        <div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_nonreg_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div>
                                    </div>
                                </div>

                                <div class="row g-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Crypto <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Capital Asset. Gains subject to Capital Gains Tax (50% inclusion) when sold or traded."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p1_crypto" value="5,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p1_crypto_ret" value="8.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p1_crypto_ret_retire" value="8.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="col-12 col-xl-6 p2-column">
                          <div class="card border-secondary surface-card shadow-none">
                            <div class="card-body p-3 p-md-4">
                              <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom border-secondary">
                                <h6 class="text-purple mb-0 fw-bold text-uppercase ls-1" style="color: var(--purple);">P2 Asset Mix</h6>
                                <button class="btn btn-sm btn-outline-primary rounded-circle p-1 d-flex align-items-center justify-content-center" style="width:28px; height:28px; color: var(--purple); border-color: var(--purple);" type="button" data-bs-toggle="collapse" data-bs-target="#p2_assets_collapse" aria-expanded="false" title="Expand/Collapse">
                                  <i class="bi bi-chevron-down"></i>
                                </button>
                              </div>

                              <div class="collapse" id="p2_assets_collapse">
                                <div class="row g-2 align-items-end mb-3"><div class="col-3"><label class="form-label text-muted mb-0">Account</label></div><div class="col-5 asset-bal-col"><label class="form-label text-muted mb-0">Balance ($)</label></div><div class="col-4 asset-ret-col"><label class="form-label text-muted mb-0 lbl-ret">Return (%)</label></div><div class="col-3 adv-asset-col" style="display:none;"><label class="form-label text-warning mb-0" title="Post-Retirement Return">Ret. Ret(%)</label></div></div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Cash <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Interest income is 100% taxable at your marginal rate. No tax sheltering."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_cash" value="15,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_cash_ret" value="2.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_cash_ret_retire" value="2.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        TFSA <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Tax-Free Savings Account. Growth and withdrawals are 100% tax-free."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_tfsa" value="35,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_tfsa_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_tfsa_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        RRSP <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Registered Retirement Savings Plan. Tax-deductible contributions. Tax-deferred growth. 100% taxable withdrawals."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_rrsp" value="42,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_rrsp_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_rrsp_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        LIRF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Locked-in Retirement Account (LIRA). Pension funds locked until retirement. Tax-deferred."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_lirf" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_lirf_ret" value="6.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_lirf_ret_retire" value="6.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        LIF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Life Income Fund. Payout vehicle for LIRA. Has min/max annual limits. 100% taxable."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_lif" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_lif_ret" value="5.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_lif_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        RRIF <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Registered Retirement Income Fund. Payout vehicle for RRSP. Mandatory minimum withdrawals. 100% taxable."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_rrif_acct" value="0"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_rrif_acct_ret" value="5.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_rrif_acct_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Non-Reg <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Taxable Investment Account. Yields (dividends/interest) taxed annually. Capital gains taxed at 50% inclusion on sale."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_nonreg" value="5,000"></div>
                                    <div class="col-4 asset-ret-col">
                                        <div class="d-flex flex-column gap-1">
                                            <div class="input-group input-group-sm" title="Total Return"><span class="input-group-text border-secondary text-muted px-1" style="font-size:0.7rem;">Tot</span><input type="number" step="0.01" class="form-control live-calc px-1" id="p2_nonreg_ret" value="5.0"><span class="input-group-text px-1">%</span></div>
                                            <div class="input-group input-group-sm" title="Yield (Dividends/Interest)"><span class="input-group-text border-secondary text-muted px-1" style="font-size:0.7rem;">Yld</span><input type="number" step="0.01" class="form-control live-calc px-1" id="p2_nonreg_yield" value="2.0"><span class="input-group-text px-1">%</span></div>
                                        </div>
                                    </div>
                                    <div class="col-3 adv-asset-col" style="display:none;">
                                        <div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_nonreg_ret_retire" value="5.0"><span class="input-group-text border-warning text-warning">%</span></div>
                                    </div>
                                </div>

                                <div class="row g-2">
                                    <div class="col-3 pt-2 small fw-medium d-flex align-items-center">
                                        Crypto <button type="button" class="btn btn-link p-0 ms-1 text-muted info-btn" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-content="Capital Asset. Gains subject to Capital Gains Tax (50% inclusion) when sold or traded."><i class="bi bi-info-circle" style="font-size:0.75rem;"></i></button>
                                    </div>
                                    <div class="col-5 asset-bal-col"><input type="text" class="form-control form-control-sm live-calc formatted-num" id="p2_crypto" value="2,000"></div><div class="col-4 asset-ret-col"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc" id="p2_crypto_ret" value="8.0"><span class="input-group-text">%</span></div></div><div class="col-3 adv-asset-col" style="display:none;"><div class="input-group input-group-sm"><input type="number" step="0.01" class="form-control live-calc border-warning" id="p2_crypto_ret_retire" value="8.0"><span class="input-group-text border-warning text-warning">%</span></div></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-between surface-card border-bottom border-secondary p-3">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-house-heart text-danger fs-4 me-3"></i>
                        <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">3. Real Estate & Mortgage</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Property Tracking" data-bs-content="Track home equity and mortgage payoff. <br><b>Growth:</b> Annual increase in property value.<br><b>Include in NW:</b> Toggle this if you plan to sell the home to fund retirement. If unchecked, it remains an asset but isn't counted as liquid retirement cash.">
                          <i class="bi bi-info-circle"></i>
                        </button>
                      </div>
                      <button type="button" class="btn btn-sm btn-primary px-3 rounded-pill" id="btnAddProperty"><i class="bi bi-plus-lg me-1"></i> Add Property</button>
                    </div>
                    <div class="card-body p-4">
                      <div id="real-estate-container"></div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center surface-card border-bottom border-secondary p-3">
                        <i class="bi bi-cash-coin text-warning fs-4 me-3"></i>
                        <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">4. Income & Taxation</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Income & Tax" data-bs-content="Enter <b>Gross Annual Income</b> (before tax). The system automatically calculates Federal and Provincial taxes based on your selected Province. <br><br>Use 'Add Stream' for side hustles or rental income.">
                          <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                    <div class="card-body p-4">
                      <div class="row mb-4">
                        <div class="col-12 col-md-4">
                          <label class="form-label fw-bold">Province of Residence</label>
                          <select class="form-select live-calc" id="tax_province">
                            <option value="ON" selected>Ontario</option><option value="AB">Alberta</option><option value="BC">British Columbia</option><option value="MB">Manitoba</option><option value="NB">New Brunswick</option><option value="NL">Newfoundland & Labrador</option><option value="NS">Nova Scotia</option><option value="PE">Prince Edward Island</option><option value="QC">Quebec</option><option value="SK">Saskatchewan</option>
                          </select>
                          <div class="mt-2"><a href="https://www.canada.ca/en/revenue-agency/services/tax/individuals/frequently-asked-questions-individuals/canadian-income-tax-rates-individuals-current-previous-years.html" target="_blank" class="small text-muted text-decoration-none border-bottom border-secondary"><i class="bi bi-link-45deg"></i> Source: CRA 2026 Rates</a></div>
                        </div>
                      </div>
                      
                      <div class="row g-4 mb-4">
                        <div class="col-12 col-xl-6">
                          <div class="card h-100 border-secondary surface-card shadow-none">
                            <div class="card-body p-4">
                              <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom border-secondary">
                                <h6 class="text-info mb-0 fw-bold text-uppercase ls-1">Player 1 Income</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3 py-1" id="btnAddIncomeP1"><i class="bi bi-plus-lg me-1"></i>Add Stream</button>
                              </div>
                              <div class="row g-3 mb-4">
                                <div class="col-8"><label class="form-label">Gross Annual Income</label><div class="input-group"><span class="input-group-text">$</span><input type="text" class="form-control live-calc formatted-num" id="p1_income" value="95,000"></div></div>
                                <div class="col-4"><label class="form-label">Growth</label><div class="input-group"><input type="text" class="form-control live-calc formatted-num" id="p1_income_growth" value="2.0"><span class="input-group-text">%</span></div></div>
                              </div>
                              <div id="p1-additional-income-container" class="mb-4"></div>
                              <div class="tax-details-box border-secondary" id="p1_tax_details"></div>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-xl-6 p2-column">
                          <div class="card h-100 border-secondary surface-card shadow-none">
                            <div class="card-body p-4">
                              <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom border-secondary">
                                <h6 class="text-purple mb-0 fw-bold text-uppercase ls-1" style="color: var(--purple);">Player 2 Income</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3 py-1" id="btnAddIncomeP2"><i class="bi bi-plus-lg me-1"></i>Add Stream</button>
                              </div>
                              <div class="row g-3 mb-4">
                                <div class="col-8"><label class="form-label">Gross Annual Income</label><div class="input-group"><span class="input-group-text">$</span><input type="text" class="form-control live-calc formatted-num" id="p2_income" value="70,000"></div></div>
                                <div class="col-4"><label class="form-label">Growth</label><div class="input-group"><input type="text" class="form-control live-calc formatted-num" id="p2_income_growth" value="2.0"><span class="input-group-text">%</span></div></div>
                              </div>
                              <div id="p2-additional-income-container" class="mb-4"></div>
                              <div class="tax-details-box border-secondary" id="p2_tax_details"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="card border-primary border-opacity-50 bg-primary bg-opacity-10 mt-2">
                        <div class="card-body p-4">
                          <div class="row text-center align-items-center">
                            <div class="col-md-6 border-end border-primary border-opacity-25 mb-3 mb-md-0">
                              <div class="household-total-label fw-bold text-primary mb-2">Total Household (Gross)</div>
                              <div class="household-total-val" id="household_gross_display">$0</div>
                            </div>
                            <div class="col-md-6">
                              <div class="household-total-label fw-bold text-success mb-2">Total Household (Net)</div>
                              <div class="household-total-val text-success" id="household_net_display">$0</div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="row g-4 mt-2 p2-column">
                        <div class="col-12">
                            <div class="p-3 border border-secondary rounded-3 surface-card bg-info bg-opacity-10">
                                <div class="form-check form-switch d-flex align-items-center gap-3 ms-4">
                                    <input class="form-check-input live-calc fs-4 mt-0" type="checkbox" id="pension_split_enabled">
                                    <div>
                                        <label class="form-check-label fw-bold" for="pension_split_enabled">Enable Pension Income Splitting</label>
                                        <div class="small text-muted">Automatically optimizes taxes by splitting eligible pension income (RRIF, LIF, DB Pension) between spouses aged 65+.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-between surface-card border-bottom border-secondary p-3">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-cart4 text-white fs-4 me-3"></i>
                        <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">5. Living Expenses</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Budgeting" data-bs-content="Enter your current monthly or annual spending. <br><br><b>Simple Mode:</b> Set one budget for working years and one for retirement.<br><b>Advanced Mode:</b> Define spending for 3 phases of retirement: Go-Go (Active), Slow-Go (Less active), and No-Go (Late stage).">
                          <i class="bi bi-info-circle"></i>
                        </button>
                      </div>
                      <div class="form-check form-switch mb-0">
                        <input class="form-check-input live-calc mt-1" type="checkbox" id="expense_mode_advanced" role="switch">
                        <label class="form-check-label small fw-bold text-uppercase ls-1 text-muted ms-1" for="expense_mode_advanced">Adv. Mode</label>
                      </div>
                    </div>
                    <div class="card-body p-4">
                      <div id="expense-phase-controls" class="row g-4 mb-4 p-4 border border-secondary rounded-3 surface-card" style="display:none;">
                        <div class="col-md-6">
                          <label class="form-label text-info fw-bold">Go-Go Phase Ends (Age)</label>
                          <input type="range" class="form-range live-calc mt-2" id="exp_gogo_age" min="60" max="90" value="75">
                          <div class="d-flex justify-content-between text-muted small mt-1"><span>60</span><span id="exp_gogo_val" class="fw-bold fs-6 text-info">75</span><span>90</span></div>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label text-primary fw-bold">Slow-Go Phase Ends (Age)</label>
                          <input type="range" class="form-range live-calc mt-2" id="exp_slow_age" min="70" max="100" value="85">
                          <div class="d-flex justify-content-between text-muted small mt-1"><span>70</span><span id="exp_slow_val" class="fw-bold fs-6 text-primary">85</span><span>100</span></div>
                        </div>
                      </div>
                      
                      <div class="table-responsive rounded-3 border border-secondary mb-4 shadow-sm">
                        <table class="table table-dark table-sm align-middle mb-0" id="expensesTable">
                          <thead><tr class="surface-card" id="expenseTableHeader"></tr></thead>
                          <tbody id="expenseTableBody" class="border-top-0"></tbody>
                        </table>
                      </div>
                      
                      <div class="card border-warning border-opacity-50 bg-warning bg-opacity-10">
                        <div class="card-body p-3 text-center" id="expenseFooter"></div>
                      </div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center surface-card border-bottom border-secondary p-3">
                      <i class="bi bi-credit-card-2-front text-danger fs-4 me-3"></i>
                      <h5 class="mb-0 fw-bold text-uppercase ls-1 me-2">6. Other Liabilities</h5>
                      <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Debts" data-bs-content="Track other debts like Car Loans, Student Loans, or LOCs. <br><b>Note:</b> Mortgages should be tracked in the Real Estate section above.">
                        <i class="bi bi-info-circle"></i>
                      </button>
                    </div>
                    <div class="card-body p-4">
                      <div id="debt-container" class="mb-4"></div>
                      <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" id="btnAddDebt"><i class="bi bi-plus-lg me-1"></i> Add Liability</button>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center justify-content-between surface-card border-bottom border-secondary p-3">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-gift text-success fs-4 me-3"></i>
                        <h5 class="mb-0 fw-bold text-uppercase ls-1 me-2">7. Windfalls & Inheritance</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Windfalls" data-bs-content="One-time cash inflows like inheritance, selling a business, or downsizing property. <br><b>Taxable:</b> Check this if the amount will be added to your taxable income for that year (e.g. severance, RRSP deregistration).">
                            <i class="bi bi-info-circle"></i>
                        </button>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" id="btnAddWindfall"><i class="bi bi-plus-lg me-1"></i> Add Event</button>
                    </div>
                    <div class="card-body p-4">
                      <div id="windfall-container"></div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center surface-card border-bottom border-secondary p-3">
                        <i class="bi bi-bank text-primary fs-4 me-3"></i>
                        <h5 class="mb-0 me-2 fw-bold text-uppercase ls-1">8. Government Benefits</h5>
                        <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="CPP / OAS / Pension" data-bs-content="<b>CPP:</b> Enter the estimate from your Service Canada account. The app will automatically adjust it if you take it early (age 60) or late (age 70).<br><br><b>OAS:</b> Max OAS requires 40 years of residency in Canada between ages 18 and 65. If you have less, it is prorated.">
                          <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                    <div class="card-body p-4">
                      <div class="row g-4">
                        <div class="col-12 col-md-6">
                          <div class="p-4 border border-secondary rounded-3 surface-card h-100">
                            <h6 class="text-info mb-4 fw-bold text-uppercase ls-1 pb-2 border-bottom border-secondary">Player 1 Benefits</h6>
                            
                            <div class="mb-4">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-bold fs-6 text-white">Canada Pension Plan (CPP)</label>
                                <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p1_cpp_enabled" checked></div>
                              </div>
                              <div id="p1_cpp_inputs">
                                <div class="d-flex justify-content-between mb-2">
                                  <label class="form-label small text-muted mb-0">Est. Payout at Age 65</label>
                                  <a href="https://www.canada.ca/en/employment-social-development/services/my-account.html" target="_blank" class="text-info small text-decoration-none" tabindex="-1"><i class="bi bi-box-arrow-up-right"></i> Service Canada</a>
                                </div>
                                <div class="input-group input-group-sm mb-3">
                                  <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                  <input type="text" class="form-control live-calc formatted-num border-secondary" id="p1_cpp_est_base" value="10,000">
                                  <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/yr</span>
                                </div>
                                <label class="form-label small text-muted mt-2 d-flex justify-content-between">
                                  <span>Starts at Age: <span id="p1_cpp_start_val" class="text-info fw-bold fs-6 ms-1">65</span></span>
                                  <span class="opt-benefit text-success" id="p1_cpp_opt" style="cursor:pointer;"></span>
                                </label>
                                <input type="range" class="form-range live-calc mt-1" id="p1_cpp_start" min="60" max="70" value="65" oninput="document.getElementById('p1_cpp_start_val').innerText = this.value">
                                <div class="d-flex justify-content-between align-items-center mt-2 p-2 bg-black bg-opacity-25 rounded border border-secondary">
                                   <span class="small text-muted fw-bold">Actual Estimated Payout:</span>
                                   <span class="est-benefit small text-info fw-bold fs-6" id="p1_cpp_est">$10,000/yr</span>
                                </div>
                              </div>
                            </div>

                            <div class="mb-4 pt-4 border-top border-secondary">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-bold fs-6 text-white">Old Age Security (OAS)</label>
                                <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p1_oas_enabled" checked></div>
                              </div>
                              <div id="p1_oas_inputs">
                                <div class="d-flex justify-content-between mb-0">
                                  <label class="form-label small text-muted mb-0">Years in Canada (by age 65)</label>
                                  <a href="https://estimateursv-oasestimator.service.canada.ca/en" target="_blank" class="text-info small text-decoration-none" tabindex="-1"><i class="bi bi-box-arrow-up-right"></i> Estimator</a>
                                </div>
                                <div class="d-flex align-items-center gap-3 mt-2 mb-3">
                                    <input type="range" class="form-range live-calc flex-grow-1" id="p1_oas_years" min="0" max="40" value="40" oninput="document.getElementById('p1_oas_years_val').innerText = this.value">
                                    <span class="text-info fw-bold small text-nowrap"><span id="p1_oas_years_val">40</span> / 40</span>
                                </div>
                                <label class="form-label small text-muted mt-2 d-flex justify-content-between">
                                  <span>Starts at Age: <span id="p1_oas_start_val" class="text-info fw-bold fs-6 ms-1">65</span></span>
                                  <span class="opt-benefit text-success" id="p1_oas_opt" style="cursor:pointer;"></span>
                                </label>
                                <input type="range" class="form-range live-calc mt-1" id="p1_oas_start" min="65" max="70" value="65" oninput="document.getElementById('p1_oas_start_val').innerText = this.value">
                                <div class="d-flex justify-content-between align-items-center mt-2 p-2 bg-black bg-opacity-25 rounded border border-secondary">
                                   <span class="small text-muted fw-bold">Actual Estimated Payout:</span>
                                   <span class="est-benefit small text-info fw-bold fs-6" id="p1_oas_est">$8,908/yr</span>
                                </div>
                              </div>
                            </div>

                            <div class="mt-4 pt-4 border-top border-secondary">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                  <label class="form-label mb-0 fw-bold fs-6 text-white">Defined Benefit (DB) Pension</label>
                                  <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p1_db_enabled"></div>
                              </div>
                              <div id="p1_db_inputs" style="display:none;">
                                
                                <div class="mb-3 border-bottom border-secondary pb-3">
                                    <label class="form-label small fw-bold text-info mb-2">Lifetime Pension</label>
                                    <div class="input-group input-group-sm mb-2">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                     <input type="text" class="form-control live-calc formatted-num border-secondary" id="p1_db_lifetime" value="0">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/mo</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label small text-muted mb-0">Starts at Age: <span id="p1_db_lifetime_start_val" class="text-info fw-bold">60</span></label>
                                        <input type="range" class="form-range live-calc w-50" id="p1_db_lifetime_start" min="50" max="75" value="60" oninput="document.getElementById('p1_db_lifetime_start_val').innerText = this.value">
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label small fw-bold text-info mb-2">Bridge Benefit <span class="text-muted fw-normal">(Ends at age 65)</span></label>
                                    <div class="input-group input-group-sm mb-2">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                     <input type="text" class="form-control live-calc formatted-num border-secondary" id="p1_db_bridge" value="0">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/mo</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label small text-muted mb-0">Starts at Age: <span id="p1_db_bridge_start_val" class="text-info fw-bold">60</span></label>
                                        <input type="range" class="form-range live-calc w-50" id="p1_db_bridge_start" min="50" max="65" value="60" oninput="document.getElementById('p1_db_bridge_start_val').innerText = this.value">
                                    </div>
                                </div>

                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <div class="col-12 col-md-6 p2-column">
                          <div class="p-4 border border-secondary rounded-3 surface-card h-100">
                            <h6 class="text-purple mb-4 fw-bold text-uppercase ls-1 pb-2 border-bottom border-secondary" style="color: var(--purple);">Player 2 Benefits</h6>
                            
                            <div class="mb-4">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-bold fs-6 text-white">Canada Pension Plan (CPP)</label>
                                <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p2_cpp_enabled" checked></div>
                              </div>
                              <div id="p2_cpp_inputs">
                                <div class="d-flex justify-content-between mb-2">
                                  <label class="form-label small text-muted mb-0">Est. Payout at Age 65</label>
                                  <a href="https://www.canada.ca/en/employment-social-development/services/my-account.html" target="_blank" class="text-info small text-decoration-none" tabindex="-1" style="color: var(--purple) !important;"><i class="bi bi-box-arrow-up-right"></i> Service Canada</a>
                                </div>
                                <div class="input-group input-group-sm mb-3">
                                  <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                  <input type="text" class="form-control live-calc formatted-num border-secondary" id="p2_cpp_est_base" value="10,000">
                                  <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/yr</span>
                                </div>
                                <label class="form-label small text-muted mt-2 d-flex justify-content-between">
                                  <span>Starts at Age: <span id="p2_cpp_start_val" class="text-purple fw-bold fs-6 ms-1" style="color: var(--purple);">65</span></span>
                                  <span class="opt-benefit text-success" id="p2_cpp_opt" style="cursor:pointer;"></span>
                                </label>
                                <input type="range" class="form-range live-calc mt-1" id="p2_cpp_start" min="60" max="70" value="65" oninput="document.getElementById('p2_cpp_start_val').innerText = this.value">
                                <div class="d-flex justify-content-between align-items-center mt-2 p-2 bg-black bg-opacity-25 rounded border border-secondary">
                                   <span class="small text-muted fw-bold">Actual Estimated Payout:</span>
                                   <span class="est-benefit small text-purple fw-bold fs-6" id="p2_cpp_est" style="color: var(--purple) !important;">$10,000/yr</span>
                                </div>
                              </div>
                            </div>

                            <div class="mb-4 pt-4 border-top border-secondary">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-bold fs-6 text-white">Old Age Security (OAS)</label>
                                <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p2_oas_enabled" checked></div>
                              </div>
                              <div id="p2_oas_inputs">
                                <div class="d-flex justify-content-between mb-0">
                                  <label class="form-label small text-muted mb-0">Years in Canada (by age 65)</label>
                                  <a href="https://estimateursv-oasestimator.service.canada.ca/en" target="_blank" class="text-info small text-decoration-none" tabindex="-1" style="color: var(--purple) !important;"><i class="bi bi-box-arrow-up-right"></i> Estimator</a>
                                </div>
                                <div class="d-flex align-items-center gap-3 mt-2 mb-3">
                                    <input type="range" class="form-range live-calc flex-grow-1" id="p2_oas_years" min="0" max="40" value="40" oninput="document.getElementById('p2_oas_years_val').innerText = this.value">
                                    <span class="text-purple fw-bold small text-nowrap" style="color: var(--purple);"><span id="p2_oas_years_val">40</span> / 40</span>
                                </div>
                                <label class="form-label small text-muted mt-2 d-flex justify-content-between">
                                  <span>Starts at Age: <span id="p2_oas_start_val" class="text-purple fw-bold fs-6 ms-1" style="color: var(--purple);">65</span></span>
                                  <span class="opt-benefit text-success" id="p2_oas_opt" style="cursor:pointer;"></span>
                                </label>
                                <input type="range" class="form-range live-calc mt-1" id="p2_oas_start" min="65" max="70" value="65" oninput="document.getElementById('p2_oas_start_val').innerText = this.value">
                                <div class="d-flex justify-content-between align-items-center mt-2 p-2 bg-black bg-opacity-25 rounded border border-secondary">
                                   <span class="small text-muted fw-bold">Actual Estimated Payout:</span>
                                   <span class="est-benefit small text-purple fw-bold fs-6" id="p2_oas_est" style="color: var(--purple) !important;">$8,908/yr</span>
                                </div>
                              </div>
                            </div>

                            <div class="mt-4 pt-4 border-top border-secondary">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                  <label class="form-label mb-0 fw-bold fs-6 text-white">Defined Benefit (DB) Pension</label>
                                  <div class="form-check form-switch min-h-0 mb-0"><input class="form-check-input live-calc mt-0 fs-5" type="checkbox" role="switch" id="p2_db_enabled"></div>
                              </div>
                              <div id="p2_db_inputs" style="display:none;">
                                
                                <div class="mb-3 border-bottom border-secondary pb-3">
                                    <label class="form-label small fw-bold text-purple mb-2" style="color: var(--purple) !important;">Lifetime Pension</label>
                                    <div class="input-group input-group-sm mb-2">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                     <input type="text" class="form-control live-calc formatted-num border-secondary" id="p2_db_lifetime" value="0">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/mo</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label small text-muted mb-0">Starts at Age: <span id="p2_db_lifetime_start_val" class="text-purple fw-bold" style="color: var(--purple) !important;">60</span></label>
                                        <input type="range" class="form-range live-calc w-50" id="p2_db_lifetime_start" min="50" max="75" value="60" oninput="document.getElementById('p2_db_lifetime_start_val').innerText = this.value">
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label small fw-bold text-purple mb-2" style="color: var(--purple) !important;">Bridge Benefit <span class="text-muted fw-normal">(Ends at age 65)</span></label>
                                    <div class="input-group input-group-sm mb-2">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                     <input type="text" class="form-control live-calc formatted-num border-secondary" id="p2_db_bridge" value="0">
                                     <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">/mo</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label small text-muted mb-0">Starts at Age: <span id="p2_db_bridge_start_val" class="text-purple fw-bold" style="color: var(--purple) !important;">60</span></label>
                                        <input type="range" class="form-range live-calc w-50" id="p2_db_bridge_start" min="50" max="65" value="60" oninput="document.getElementById('p2_db_bridge_start_val').innerText = this.value">
                                    </div>
                                </div>

                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header d-flex align-items-center surface-card border-bottom border-secondary p-3">
                      <i class="bi bi-graph-up-arrow text-secondary fs-4 me-3"></i>
                      <h5 class="mb-0 fw-bold text-uppercase ls-1">9. Economic Assumptions</h5>
                    </div>
                    <div class="card-body p-4">
                      <div class="row">
                        <div class="col-md-4">
                          <label class="form-label fw-bold mb-2">Long-term Inflation Rate</label>
                          <div class="input-group mb-2"><input type="number" step="0.01" class="form-control live-calc" id="inflation_rate" value="2.1"><span class="input-group-text">%</span></div>
                          <a href="https://www.bankofcanada.ca/core-functions/monetary-policy/inflation/" target="_blank" class="small text-muted text-decoration-none border-bottom border-secondary"><i class="bi bi-link-45deg"></i> BoC Target: 2%</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>

              <div class="tab-pane fade p-0" id="summary-pane" role="tabpanel">
                <div class="card border-0 shadow-none">
                  <div class="card-header d-flex justify-content-end p-3 border-bottom border-secondary surface-card">
                    <button class="btn btn-sm btn-outline-success rounded-pill px-3" id="btnExportCSV"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export CSV</button>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-container border-0 rounded-0" id="summaryTableContainer" style="max-height: 85vh; overflow-y: auto;">
                      <div id="projectionGrid"></div>
                      <table class="summary-table" id="oldSummaryTable" style="display:none;"></table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade p-4 p-md-5" id="strategy-pane" role="tabpanel">
                <div class="row g-5 mb-5">
                  <div class="col-md-6 border-end border-secondary">
                    <div class="d-flex align-items-center mb-4 pb-2 border-bottom border-success border-opacity-50">
                      <div class="bg-success bg-opacity-10 text-success p-2 rounded me-3 d-flex"><i class="bi bi-piggy-bank fs-3"></i></div>
                      <h5 class="text-success mb-0 me-2 fw-bold text-uppercase ls-1">Accumulation Strategy</h5>
                      <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Savings Priority" data-bs-content="<b>Drag and Drop</b> the items below to change the order.<br><br>When you have extra money at the end of the year, this list determines which account gets filled first (e.g., max out TFSA, then RRSP, then Cash).">
                        <i class="bi bi-info-circle"></i>
                      </button>
                    </div>
                    <p class="small text-muted mb-4 px-2">Drag to prioritize where surplus cash is saved. Top items fill first.</p>
                    <div id="strat-accum-container" class="mb-0 px-2"></div>
                  </div>

                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-4 pb-2 border-bottom border-warning border-opacity-50">
                      <div class="bg-warning bg-opacity-10 text-warning p-2 rounded me-3 d-flex"><i class="bi bi-wallet2 fs-3"></i></div>
                      <h5 class="text-warning mb-0 me-2 fw-bold text-uppercase ls-1">Decumulation Strategy</h5>
                      <button type="button" class="btn btn-link p-0 text-muted info-btn" data-bs-toggle="popover" data-bs-title="Withdrawal Order" data-bs-content="<b>Drag and Drop</b> to prioritize.<br><br>When you retire (or spend more than you earn), this determines which assets are sold first to cover your expenses. Optimizing this can save significant tax dollars.">
                        <i class="bi bi-info-circle"></i>
                      </button>
                    </div>
                    <p class="small text-muted mb-4 px-2">Drag to prioritize withdrawal sources during retirement/deficits.</p>
                    <div id="strat-decumulation" class="mb-0 px-2"></div>
                  </div>
                </div>

                <div class="row g-5">
                  <div class="col-md-6">
                    <div class="card border-secondary surface-card shadow-sm h-100">
                        <div class="card-header border-secondary text-uppercase small fw-bold text-muted d-flex justify-content-between align-items-center">
                            <span>Annual Contribution Limits</span>
                            <a href="https://www.canada.ca/en/revenue-agency/services/tax/individuals/topics/rrsps-related-plans/contributing-a-rrsp-prpp/contributions-affect-your-rrsp-prpp-deduction-limit.html" target="_blank" class="text-muted" title="CRA Limits Info"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small text-success fw-bold">TFSA Annual Limit</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                        <input type="text" class="form-control live-calc formatted-num border-secondary" id="cfg_tfsa_limit" value="7,000">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-warning fw-bold">RRSP Max Limit</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-black bg-opacity-25 border-secondary text-muted">$</span>
                                        <input type="text" class="form-control live-calc formatted-num border-secondary" id="cfg_rrsp_limit" value="32,960">
                                    </div>
                                    <div class="form-text text-muted" style="font-size: 0.65rem;">Cap applied to 18% of inc.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="strategy-opt-box border-secondary surface-card shadow-sm h-100 p-3">
                      <div class="strategy-opt-header mb-3 fw-bold text-uppercase small text-muted border-bottom border-secondary pb-2"><i class="bi bi-sliders text-info me-2"></i>Exceptions / Overrides</div>
                      <div class="form-check mb-3">
                        <input class="form-check-input live-calc mt-1" type="checkbox" id="skip_first_tfsa_p1">
                        <label class="form-check-label small" for="skip_first_tfsa_p1">P1: Skip 1st Year TFSA Contrib.</label>
                      </div>
                      <div class="form-check mb-4 border-bottom border-secondary pb-3">
                        <input class="form-check-input live-calc mt-1" type="checkbox" id="skip_first_rrsp_p1">
                        <label class="form-check-label small" for="skip_first_rrsp_p1">P1: Skip 1st Year RRSP Contrib.</label>
                      </div>
                      <div class="p2-column">
                        <div class="form-check mb-3">
                          <input class="form-check-input live-calc mt-1" type="checkbox" id="skip_first_tfsa_p2">
                          <label class="form-check-label small" for="skip_first_tfsa_p2">P2: Skip 1st Year TFSA Contrib.</label>
                        </div>
                        <div class="form-check mb-2">
                          <input class="form-check-input live-calc mt-1" type="checkbox" id="skip_first_rrsp_p2">
                          <label class="form-check-label small" for="skip_first_rrsp_p2">P2: Skip 1st Year RRSP Contrib.</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade p-3 p-md-5" id="cashflow-pane" role="tabpanel">
                <div class="card border-0 bg-transparent shadow-none" style="overflow: hidden; width: 100%;">
                  <div class="card-body p-0">
                    <div class="d-flex align-items-center justify-content-center mb-5 p-4 surface-card border border-secondary rounded-3 shadow-sm mx-auto" style="max-width: 800px;">
                      <label class="form-label me-4 mb-0 fw-bold fs-6">Timeline Year:</label>
                      <input type="range" class="form-range flex-grow-1" id="yearSlider" min="0" max="40" value="0">
                      <div class="ms-4 text-center ps-4 border-start border-secondary">
                        <div class="fs-3 fw-bold text-info" id="sliderYearDisplay">2026</div>
                        <div class="text-muted small fw-medium text-uppercase ls-1 mt-1" id="cfAgeDisplay">(Age: --)</div>
                      </div>
                    </div>
                    <div id="sankey_chart" style="width: 100%; height: 600px;"></div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade p-4 p-md-5" id="sim-pane" role="tabpanel">
                <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary">
                    <i class="bi bi-lightbulb text-warning me-2"></i>Smart Optimizers
                </h5>
                <div class="row g-4">
                    <div class="col-12 col-xl-6">
                        <div class="card p-4 border-secondary surface-card shadow-sm h-100 transition-all opacity-50">
                            <h6 class="text-muted fw-bold mb-2 fs-5"><i class="bi bi-infinity me-2"></i>Die With Zero (Maintenance)</h6>
                            <p class="small text-muted mb-4">Calculates how much more you can spend, or how much earlier you can retire, to end up with exactly $0 at the end of your life expectancy.</p>
                            <div class="d-grid mb-3 mt-auto">
                                <button class="btn btn-outline-secondary fw-bold py-2" id="btnRunDwZ" onclick="app.optimizers.runDieWithZero()" disabled>
                                    <i class="bi bi-play-circle-fill me-2"></i>Currently Unavailable
                                </button>
                            </div>
                            <div id="dwz_results" style="display:none;" class="mt-3 pt-3 border-top border-secondary">
                                </div>
                        </div>
                    </div>
                    
                    <div class="col-12 col-xl-6">
                        <div class="card p-4 border-secondary surface-card shadow-sm h-100 opacity-50">
                            <h6 class="text-muted fw-bold mb-2 fs-5"><i class="bi bi-lock me-2"></i>More Coming Soon</h6>
                            <p class="small text-muted mb-4">Future updates will include CPP/OAS Breakeven calculations, Sequence of Returns Risk testing, and RRSP Meltdown strategies.</p>
                        </div>
                    </div>
                </div>
              </div>

              <div class="tab-pane fade p-4 p-md-5" id="risk-pane" role="tabpanel">
                <div class="row g-5">
                    <div class="col-12 col-xl-3">
                        <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary d-flex align-items-center">
                            <i class="bi bi-gear-wide-connected me-2 text-danger"></i>Simulation Settings
                            <button type="button" class="btn btn-link p-0 ms-2 text-muted info-btn" data-bs-toggle="popover" data-bs-title="About Monte Carlo" data-bs-html="true" data-bs-content="<b>What is this?</b><br>This simulates your plan hundreds of times with randomized investment returns to test resilience against market crashes.<br><br><b>How to read:</b><br><ul><li><b>Success Rate:</b> % of simulations where you don't run out of money.</li><li><b>Median:</b> The 'average' outcome.</li><li><b>P10 (Pessimistic):</b> A 'bad luck' scenario (bottom 10%). If this line stays above $0, your plan is robust.</li></ul>">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </h5>
                        <div class="card p-4 surface-card border-secondary shadow-sm mb-4">
                            <label class="form-label small fw-bold text-muted">Number of Runs</label>
                            <select class="form-select mb-3" id="mc_sim_count">
                                <option value="100">100 (Fast)</option>
                                <option value="500" selected>500 (Balanced)</option>
                                <option value="1000">1000 (Precise)</option>
                            </select>
                            
                            <label class="form-label small fw-bold text-muted">Simulation Method</label>
                            <select class="form-select mb-3" id="mc_sim_method" onchange="document.getElementById('mc_vol_wrap').style.display = this.value === 'historical' ? 'none' : 'block'">
                                <option value="random" selected>Standard (Normal Distribution)</option>
                                <option value="historical">Historical Data (S&P 500 Bootstrap)</option>
                            </select>

                            <div id="mc_vol_wrap">
                                <label class="form-label small fw-bold text-muted">Market Volatility</label>
                                <select class="form-select mb-4" id="mc_volatility">
                                    <option value="0.08">Low (8% Std Dev)</option>
                                    <option value="0.12" selected>Medium (12% Std Dev)</option>
                                    <option value="0.16">High (16% Std Dev)</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-danger w-100 fw-bold py-2" onclick="app.optimizers.runMonteCarlo()">
                                <i class="bi bi-play-circle-fill me-2"></i> Run Monte Carlo
                            </button>
                        </div>

                        <div class="card p-3 border-danger bg-danger bg-opacity-10 text-center" id="mc_stats_box" style="display:none;">
                            <div class="small text-uppercase fw-bold text-danger mb-1">Success Rate</div>
                            <div class="display-4 fw-bold text-danger" id="mc_success_rate">--%</div>
                            <div class="small text-muted mt-2">Simulations ending > $0</div>
                        </div>
                    </div>
                    <div class="col-12 col-xl-9">
                        <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary"><i class="bi bi-activity me-2 text-info"></i>Simulation Outcomes</h5>
                        <div class="card p-4 border-secondary surface-card shadow-sm h-100">
                             <div style="height: 500px; position: relative; width: 100%;">
                                <canvas id="chartMonteCarlo"></canvas>
                             </div>
                             <div class="text-center text-muted small mt-3">
                                 Displaying random scenarios based on standard deviation. 
                                 <span class="text-white fw-bold">Solid Lines</span> represent the Median (50th percentile) and "Bad Luck" (10th percentile) cases.
                             </div>
                        </div>
                    </div>
                </div>
              </div>

              <div class="tab-pane fade p-4 p-md-5" id="scenarios-pane" role="tabpanel">
                <div class="row g-5">
                  <div class="col-md-6 border-end border-secondary pe-md-5">
                    <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary"><i class="bi bi-hdd-network me-2 text-info"></i>Advanced File Options</h5>
                    <div class="d-grid gap-4 mt-2">
                      <div class="card p-4 surface-card border-secondary shadow-sm">
                        <h6 class="text-info fw-bold mb-3 d-flex align-items-center"><div class="bg-info bg-opacity-10 p-2 rounded me-3"><i class="bi bi-upload fs-5"></i></div>Import Plan File</h6>
                        <p class="small text-muted mb-4">Load a previously exported .json plan file from your computer to restore all settings and inputs.</p>
                        <button class="btn btn-outline-primary fw-bold" onclick="document.getElementById('fileUpload').click()">Choose JSON File...</button>
                        <input type="file" id="fileUpload" style="display: none;" accept=".json">
                      </div>
                      
                      <div class="card p-4 surface-card border-danger border-opacity-50 shadow-sm mt-3">
                        <h6 class="text-danger fw-bold mb-3 d-flex align-items-center"><div class="bg-danger bg-opacity-10 p-2 rounded me-3"><i class="bi bi-trash3 fs-5"></i></div>Reset Application</h6>
                        <p class="small text-muted mb-4">Wipe all current unsaved data, delete the local browser auto-save, and reset the application to its default state.</p>
                        <button class="btn btn-outline-danger fw-bold" id="btnClearStorage">Reset All Local Data</button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 ps-md-5">
                    <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary"><i class="bi bi-folder-check me-2 text-success"></i>Manage Saved Plans</h5>
                    <div class="card border-0 shadow-none bg-transparent">
                      <ul class="list-group rounded-3 shadow-sm border border-secondary" id="scenarioList">
                        </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade p-4 p-md-5" id="compare-pane" role="tabpanel">
                <div class="row mb-5">
                  <div class="col-12">
                    <h5 class="text-muted small text-uppercase fw-bold ls-1 mb-4 pb-2 border-bottom border-secondary"><i class="bi bi-input-cursor me-2 text-info"></i>Comparison Controls</h5>
                    <div class="card p-4 mb-3 surface-card border-secondary shadow-sm">
                      <p class="small text-muted mb-4 fw-medium">Select the scenarios you wish to compare. The chart will update automatically to display their Net Worth trajectories side-by-side.</p>
                      <div class="d-flex flex-wrap gap-3" id="compareSelectionArea"></div>
                    </div>
                  </div>
                </div>
                <div class="row g-4">
                  <div class="col-12">
                    <div class="card p-4 border-secondary surface-card shadow-sm">
                        <h6 class="text-center text-success mb-4 fw-bold text-uppercase ls-1">Net Worth Trajectory Comparison</h6>
                        <div style="height: 500px; position: relative; width: 100%;">
                            <canvas id="chartNW"></canvas>
                        </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="floating-widget-container">
      
      <div class="card shadow-lg border-secondary quick-adjust-card" id="quickAdjustWidget">
        <div class="card-header border-bottom border-secondary p-3 d-flex justify-content-between align-items-center">
          <h6 class="text-info fw-bold text-uppercase ls-1 mb-0"><i class="bi bi-sliders me-2"></i>Quick Adjust</h6>
          <button type="button" class="btn-close btn-close-white" id="closeWidgetBtn" aria-label="Close"></button>
        </div>
        <div class="card-body p-4">
          <p class="small text-muted mb-4 pb-2 border-bottom border-secondary">Tweak key variables here to instantly update your projections.</p>
          
          <div class="mb-4 pt-2">
            <label class="form-label text-info fw-bold">P1 Retirement Age</label>
            <input type="range" class="form-range" min="18" max="80" id="qa_p1_retireAge_range">
            <div class="d-flex justify-content-between"><span class="small text-muted">Now</span><span class="fw-bold text-info" id="qa_p1_retireAge_val">60</span><span class="small text-muted">80</span></div>
          </div>
          
          <div class="mb-4 p2-column pt-2">
            <label class="form-label text-purple fw-bold">P2 Retirement Age</label>
            <input type="range" class="form-range" min="18" max="80" id="qa_p2_retireAge_range">
            <div class="d-flex justify-content-between"><span class="small text-muted">Now</span><span class="fw-bold text-purple" id="qa_p2_retireAge_val">60</span><span class="small text-muted">80</span></div>
          </div>
          
          <div class="mb-4 pt-4 border-top border-secondary">
            <label class="form-label text-warning fw-bold">Inflation Rate (%)</label>
            <input type="range" class="form-range" min="1" max="8" step="0.1" id="qa_inflation_range">
            <div class="d-flex justify-content-between"><span class="small text-muted">1%</span><span class="fw-bold text-warning" id="qa_inflation_val">2.5%</span><span class="small text-muted">8%</span></div>
          </div>
          
          <div class="mb-4 pt-4 border-top border-secondary">
            <label class="form-label text-success fw-bold">Market Return (%)</label>
            <input type="range" class="form-range" min="1" max="12" step="0.1" id="qa_return_range">
            <div class="d-flex justify-content-between"><span class="small text-muted">1%</span><span class="fw-bold text-success" id="qa_return_val">6.0%</span><span class="small text-muted">12%</span></div>
            <p class="small text-muted mt-2 mb-0" style="font-size: 0.75rem;">*Updates P1 & P2 TFSA/RRSP base returns.</p>
          </div>
        </div>
      </div>
      
      <button class="btn btn-info rounded-circle shadow-lg fab-btn" id="fabQuickAdjust" title="Quick Adjust Settings">
        <i class="bi bi-sliders fs-4 text-dark"></i>
      </button>

    </div>

    <div class="modal fade" id="saveScenarioModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-secondary rounded-4">
          <div class="modal-header border-secondary p-4 surface-card rounded-top-4">
            <h5 class="modal-title fs-5 fw-bold text-white d-flex align-items-center"><div class="bg-success bg-opacity-10 text-success p-2 rounded me-3 d-flex"><i class="bi bi-floppy"></i></div>Save Plan</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <label class="form-label fw-bold text-muted text-uppercase ls-1 mb-3">Plan Name</label>
            <input type="text" id="modalScenarioName" class="form-control form-control-lg bg-black bg-opacity-25 border-secondary text-white" placeholder="e.g., Base Plan, Early Retirement...">
          </div>
          <div class="modal-footer border-secondary p-3 surface-card rounded-bottom-4">
            <button type="button" class="btn btn-outline-secondary px-4 fw-bold" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary px-4 fw-bold" id="btnModalSaveScenario">Save Plan</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content shadow-lg border-secondary rounded-4">
          <div class="modal-header border-secondary p-3 surface-card rounded-top-4">
            <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirmation</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4 text-center fw-medium text-white"></div>
          <div class="modal-footer border-secondary p-2 surface-card rounded-bottom-4 d-flex justify-content-between">
            <button type="button" class="btn btn-sm btn-outline-secondary fw-bold px-3" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-sm btn-danger fw-bold px-4" id="btnConfirmAction">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center text-muted small pb-4 fw-medium text-uppercase ls-1 mt-4">Retirement Planner Pro &copy; 2026. Data is processed locally.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="config.js"></script>
  <script src="financeEngine.js"></script>
  
  <script src="uiController.js"></script>
  <script src="dataController.js"></script>
  <script src="optimizers.js"></script> 
  
  <script src="script.js"></script>
</body>
</html>
